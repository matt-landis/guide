<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AhGo!</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        :root {
            --main-color: blue;
            --secondary-color: gold;
            --bg-color: white;
            --text-color: black;
        }
        .dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
        }
        #title-area {
            flex: 0 0 10vh;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            background-color: var(--main-color);
            color: white;
            box-sizing: border-box;
        }
        #title-area h1 {
            margin: 0;
            font-size: 1.8em;
            white-space: nowrap;
        }
        #title-area .short-desc {
            font-size: 0.9em;
            margin-left: 12px;
            opacity: 0.9;
        }
        @media (max-width: 600px) {
            #title-area .short-desc {
                display: none;
            }
        }
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        button {
            background: none;
            border: none;
            cursor: pointer;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.4em;
        }
        button:hover {
            background-color: rgba(255,255,255,0.2);
        }
        #main-area {
            flex: 0 0 55vh;
            position: relative;
        }
        #thumbnail-area {
            flex: 0 0 30vh;
            padding: 10px;
            box-sizing: border-box;
            background-color: var(--bg-color);
        }
        #footer-area {
            flex: 0 0 5vh;
            display: flex;
            align-items: center;
            padding: 0 15px;
            background-color: var(--secondary-color);
            color: black;
            font-size: 0.9em;
            box-sizing: border-box;
        }
        #progress {
            margin-right: 12px;
            font-size: 1.2em;
        }
        #status {
            flex: 1;
            text-align: center;
        }
        .swiper {
            height: 100%;
            width: 100%;
        }
        .gallery .swiper-slide {
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: flex-end;
            padding: 0px;
            color: white;
            text-shadow: 1px 1px 3px black;
            position: relative;
        }
        .poi-info {
            z-index: 2;
        }
        .poi-name {
            font-size: 2em;
            margin-bottom: 8px;
        }
        .poi-dist {
            font-size: 1.2em;
        }
        .play-button {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 80px;
            height: 80px;
            font-size: 2.5em;
            background-color: rgba(0,0,0,0.5);
            z-index: 2;
            border-radius: 50%;
        }
        @media (max-height: 600px) {
            .play-button {
                width: 60px;
                height: 60px;
                font-size: 2em;
            }
        }
        .thumbs .swiper-slide {
            height: calc(100% - 30px);
            width: 160px;
            background-size: cover;
            background-position: center;
            border-radius: 12px;
            display: flex;
            align-items: flex-end;
            padding: 10px;
            color: white;
            text-shadow: 1px 1px 3px black;
            opacity: 0.6;
            transition: opacity 0.3s;
        }
        .thumbs .swiper-slide-thumb-active {
            opacity: 1;
            border: 3px solid var(--secondary-color);
        }
        .thumbs .poi-name {
            font-size: 1em;
        }
        #settings-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        #settings-form {
            background: var(--bg-color);
            color: var(--text-color);
            padding: 25px;
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            max-height: 90vh;
            overflow-y: auto;
        }
        #settings-form label {
            display: block;
            margin: 15px 0 8px;
            font-weight: bold;
        }
        .settings-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        .circle-btn {
            width: 60px;
            height: 60px;
            font-size: 1.8em;
            background-color: var(--main-color);
        }
    </style>
</head>
<body>
    <div id="title-area">
        <div>
            <h1>AhGo!<span class="short-desc">Guide to Nearby Places</span></h1>
        </div>
        <div class="header-buttons">
            <button id="refresh" title="Refresh"><i class="fas fa-sync-alt"></i></button>
            <button id="settings-btn" title="Settings"><i class="fas fa-cog"></i></button>
        </div>
    </div>

    <div id="main-area">
        <div class="swiper gallery">
            <div class="swiper-wrapper"></div>
        </div>
    </div>

    <div id="thumbnail-area">
        <div class="swiper thumbs">
            <div class="swiper-wrapper"></div>
        </div>
    </div>

    <div id="footer-area">
        <div id="progress" style="display:none;"><i class="fas fa-spinner fa-spin"></i></div>
        <span id="status">Initializing...</span>
    </div>

    <div id="settings-modal">
        <form id="settings-form">
            <label>Units</label>
            <select id="units">
                <option value="metric">Metric (km/m)</option>
                <option value="imperial">Imperial (miles/ft)</option>
            </select>

            <label><input type="checkbox" id="dark-mode"> Dark Mode</label>

            <label><input type="checkbox" id="auto-check"> Automatically check every 30 seconds</label>

            <label>Text-to-Speech Voice</label>
            <select id="tts-voice"></select>

            <label>Categories of POIs</label>
            <div id="categories"></div>

            <label>Sources</label>
            <label><input type="checkbox" id="source-wiki" checked> Wikipedia</label>
            <label><input type="checkbox" id="source-osm" checked> OpenStreetMaps</label>

            <div class="settings-buttons">
                <button type="button" id="save-settings" class="circle-btn"><i class="fas fa-check"></i></button>
                <button type="button" id="cancel-settings" class="circle-btn"><i class="fas fa-times"></i></button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        let gallerySwiper = null;
        let thumbsSwiper = null;
        let pois = [];
        let currentUtterance = null;

        const defaultSettings = {
            units: 'metric',
            darkMode: false,
            autoCheck: false,
            ttsVoice: '',
            categories: ['Attractions', 'Museums', 'Parks', 'Historic Sites'],
            sources: ['Wikipedia', 'OpenStreetMaps']
        };
        let settings = { ...defaultSettings };

        const categoryMap = {
            'Attractions': '["tourism"="attraction"]',
            'Museums': '["tourism"="museum"]',
            'Parks': '["leisure"="park"]',
            'Historic Sites': '["historic"]'
        };

        function loadSettings() {
            const saved = localStorage.getItem('ahgoSettings');
            if (saved) {
                settings = { ...defaultSettings, ...JSON.parse(saved) };
            }
            applySettings();
        }

        function applySettings() {
            document.body.classList.toggle('dark-mode', settings.darkMode);
            document.getElementById('units').value = settings.units;
            document.getElementById('dark-mode').checked = settings.darkMode;
            document.getElementById('auto-check').checked = settings.autoCheck;
            document.getElementById('source-wiki').checked = settings.sources.includes('Wikipedia');
            document.getElementById('source-osm').checked = settings.sources.includes('OpenStreetMaps');
            populateCategories();

            if (settings.autoCheck) {
                if (window.autoInterval) clearInterval(window.autoInterval);
                window.autoInterval = setInterval(refreshPOIs, 30000);
            } else {
                if (window.autoInterval) clearInterval(window.autoInterval);
            }
        }

        function saveSettings() {
            settings.units = document.getElementById('units').value;
            settings.darkMode = document.getElementById('dark-mode').checked;
            settings.autoCheck = document.getElementById('auto-check').checked;
            settings.ttsVoice = document.getElementById('tts-voice').value;
            settings.sources = [];
            if (document.getElementById('source-wiki').checked) settings.sources.push('Wikipedia');
            if (document.getElementById('source-osm').checked) settings.sources.push('OpenStreetMaps');

            settings.categories = [];
            Object.keys(categoryMap).forEach(cat => {
                const id = `cat-${cat.replace(/\s+/g, '')}`;
                const cb = document.getElementById(id);
                if (cb && cb.checked) settings.categories.push(cat);
            });

            localStorage.setItem('ahgoSettings', JSON.stringify(settings));
            applySettings();
            document.getElementById('settings-modal').style.display = 'none';
            refreshPOIs();
        }

        function populateVoices() {
            const voices = speechSynthesis.getVoices();
            const select = document.getElementById('tts-voice');
            select.innerHTML = '<option value="">Default</option>';
            voices.forEach(voice => {
                const opt = document.createElement('option');
                opt.value = voice.name;
                opt.textContent = `${voice.name} (${voice.lang})${voice.default ? ' â€” Default' : ''}`;
                select.appendChild(opt);
            });
            if (settings.ttsVoice) select.value = settings.ttsVoice;
        }

        function populateCategories() {
            const container = document.getElementById('categories');
            container.innerHTML = '';
            Object.keys(categoryMap).forEach(cat => {
                const id = `cat-${cat.replace(/\s+/g, '')}`;
                const label = document.createElement('label');
                label.style.display = 'block';
                label.style.margin = '8px 0';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = id;
                input.checked = settings.categories.includes(cat);
                label.appendChild(input);
                label.appendChild(document.createTextNode(' ' + cat));
                container.appendChild(label);
            });
        }

        function showProgress(show) {
            document.getElementById('progress').style.display = show ? 'inline-block' : 'none';
        }

        function setStatus(text) {
            document.getElementById('status').textContent = text;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)**2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            let d = R * c;
            if (settings.units === 'imperial') {
                d *= 0.621371;
                return d.toFixed(2) + ' miles';
            }
            return d.toFixed(2) + ' km';
        }

        async function fetchPOIs(lat, lon) {
            showProgress(true);
            setStatus('Searching nearby places...');
            pois = [];

            const promises = [];
            if (settings.sources.includes('Wikipedia')) promises.push(fetchWikipedia(lat, lon));
            if (settings.sources.includes('OpenStreetMaps')) promises.push(fetchOSM(lat, lon));

            await Promise.all(promises);

            pois.sort((a, b) => a.distRaw - b.distRaw);
            updateGallery();
            showProgress(false);
            setStatus(pois.length ? `${pois.length} places found` : 'No places found nearby');
        }

        async function fetchWikipedia(lat, lon) {
            const url = `https://en.wikipedia.org/w/api.php?action=query&generator=geosearch&ggscoord=${lat}|${lon}&ggsradius=10000&ggslimit=30&prop=coordinates|pageimages|extracts&exintro&explaintext&exchars=400&piprop=thumbnail&pithumbsize=600&format=json&origin=*`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.query?.pages) {
                    Object.values(data.query.pages).forEach(page => {
                        if (page.coordinates) {
                            const coord = page.coordinates[0];
                            const distRaw = parseFloat(calculateDistance(lat, lon, coord.lat, coord.lon).split(' ')[0]);
                            pois.push({
                                name: page.title,
                                desc: page.extract?.trim() || 'No description available.',
                                dist: calculateDistance(lat, lon, coord.lat, coord.lon),
                                distRaw,
                                source: 'Wikipedia',
                                image: page.thumbnail?.source || ''
                            });
                        }
                    });
                }
            } catch (e) { console.error('Wikipedia fetch error:', e); }
        }

        async function fetchOSM(lat, lon) {
            let queries = settings.categories.map(cat => `node(around:10000,${lat},${lon})${categoryMap[cat]};`).join('');
            if (!queries) return;
            const query = `[out:json][timeout:25];(${queries});out body;`;
            const url = 'https://overpass-api.de/api/interpreter';
            try {
                const res = await fetch(url, { method: 'POST', body: `data=${encodeURIComponent(query)}` });
                const data = await res.json();
                data.elements.forEach(el => {
                    if (el.tags?.name) {
                        let image = '';
                        if (el.tags.wikimedia_commons?.startsWith('File:')) {
                            const file = encodeURIComponent(el.tags.wikimedia_commons.slice(5));
                            image = `https://commons.wikimedia.org/wiki/Special:FilePath/${file}?width=600`;
                        } else if (el.tags.image?.startsWith('http')) {
                            image = el.tags.image;
                        }
                        const distRaw = parseFloat(calculateDistance(lat, lon, el.lat, el.lon).split(' ')[0]);
                        pois.push({
                            name: el.tags.name,
                            desc: el.tags.description || (el.tags.wikipedia ? `See Wikipedia article on ${el.tags.wikipedia.split(':')[1] || el.tags.wikipedia}` : 'No description available.'),
                            dist: calculateDistance(lat, lon, el.lat, el.lon),
                            distRaw,
                            source: 'OpenStreetMap',
                            image
                        });
                    }
                });
            } catch (e) { console.error('OSM fetch error:', e); }
        }

        function updateGallery() {
            const galleryWrapper = document.querySelector('.gallery .swiper-wrapper');
            const thumbsWrapper = document.querySelector('.thumbs .swiper-wrapper');
            galleryWrapper.innerHTML = '';
            thumbsWrapper.innerHTML = '';

            if (pois.length === 0) {
                galleryWrapper.innerHTML = '<div class="swiper-slide" style="display:flex;align-items:center;justify-content:center;color:white;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><h2>No places found</h2></div>';
                thumbsWrapper.innerHTML = '';
            } else {
                pois.forEach((poi, i) => {
                    const fallbackBg = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    const gSlide = document.createElement('div');
                    gSlide.className = 'swiper-slide';
                    gSlide.style.backgroundImage = poi.image ? `url(${poi.image})` : fallbackBg;
                    gSlide.innerHTML = `
                        <div class="poi-info">
                            <div class="poi-name">${poi.name}</div>
                            <div class="poi-dist">${poi.dist}</div>
                        </div>
                        <button class="play-button" data-index="${i}"><i class="fas fa-play"></i></button>
                    `;
                    galleryWrapper.appendChild(gSlide);

                    const tSlide = document.createElement('div');
                    tSlide.className = 'swiper-slide';
                    tSlide.style.backgroundImage = poi.image ? `url(${poi.image})` : fallbackBg;
                    tSlide.innerHTML = `<div class="poi-name">${poi.name}</div>`;
                    thumbsWrapper.appendChild(tSlide);
                });
            }

            // Destroy existing swipers if they exist
            if (gallerySwiper) gallerySwiper.destroy(true, true);
            if (thumbsSwiper) thumbsSwiper.destroy(true, true);

            // Re-initialize thumbs first
            thumbsSwiper = new Swiper('.thumbs', {
                spaceBetween: 12,
                slidesPerView: 'auto',
                freeMode: true,
                watchSlidesProgress: true
            });

            // Then gallery with thumbs reference
            gallerySwiper = new Swiper('.gallery', {
                spaceBetween: 5,
                width: window.innerWidth,
                height: window.innerHeight * 0.55,
                thumbs: {
                    swiper: thumbsSwiper
                }
            });

            // Auto-stop speech when swiping to a new place
            gallerySwiper.on('slideChange', () => {
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                    document.querySelectorAll('.play-button i').forEach(ic => {
                        ic.classList.remove('fa-pause');
                        ic.classList.add('fa-play');
                    });
                }
            });

            // Re-attach play button listeners
            document.querySelectorAll('.play-button').forEach(btn => {
                btn.addEventListener('click', toggleTTS);
            });
        }

        function toggleTTS(e) {
            e.stopPropagation();
            const btn = e.currentTarget;
            const icon = btn.querySelector('i');
            const index = parseInt(btn.dataset.index);

            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                icon.classList.remove('fa-pause');
                icon.classList.add('fa-play');
            } else {
                const poi = pois[index];
                const text = `${poi.name}. ${poi.desc}`;
                currentUtterance = new SpeechSynthesisUtterance(text);

                const voices = speechSynthesis.getVoices();
                if (settings.ttsVoice) {
                    currentUtterance.voice = voices.find(v => v.name === settings.ttsVoice) || null;
                }

                currentUtterance.onend = () => {
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                };

                currentUtterance.onerror = () => {
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                };

                speechSynthesis.speak(currentUtterance);
                icon.classList.remove('fa-play');
                icon.classList.add('fa-pause');
            }
        }

        function refreshPOIs() {
            if (!navigator.geolocation) {
                setStatus('Geolocation not supported');
                showProgress(false);
                return;
            }
            setStatus('Requesting location permission...');
            navigator.geolocation.getCurrentPosition(
                pos => {
                    fetchPOIs(pos.coords.latitude, pos.coords.longitude);
                },
                err => {
                    let msg = 'Location access denied';
                    if (err.code === err.PERMISSION_DENIED) msg = 'Location permission denied';
                    else if (err.code === err.POSITION_UNAVAILABLE) msg = 'Location unavailable';
                    else if (err.code === err.TIMEOUT) msg = 'Location request timed out';
                    setStatus(msg);
                    showProgress(false);
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        // Event listeners
        document.getElementById('refresh').addEventListener('click', refreshPOIs);
        document.getElementById('settings-btn').addEventListener('click', () => {
            populateVoices(); // refresh in case voices loaded late
            document.getElementById('settings-modal').style.display = 'flex';
        });
        document.getElementById('save-settings').addEventListener('click', saveSettings);
        document.getElementById('cancel-settings').addEventListener('click', () => {
            document.getElementById('settings-modal').style.display = 'none';
        });

        // Initialize
        window.addEventListener('load', () => {
            loadSettings();
            populateVoices();
            speechSynthesis.onvoiceschanged = populateVoices; // in case not loaded yet
            refreshPOIs();
        });
    </script>
</body>
</html>
