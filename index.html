<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AhGo!</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <style>
        :root {
            --main-color: blue;
            --secondary-color: gold;
            --bg-color: white;
            --text-color: black;
        }
        .dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
        }
        html, body {
            height: 100dvh;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
        }
        #title-area {
            flex: 0 0 10dvh;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            background-color: var(--main-color);
            color: white;
            box-sizing: border-box;
            position: relative;
        }
        #title-area h1 {
            margin: 0;
            font-size: 1.8em;
            white-space: nowrap;
        }
        #title-area .short-desc {
            font-size: 0.9em;
            margin-left: 12px;
            opacity: 0.9;
        }
        @media (max-width: 600px) {
            #title-area .short-desc {
                display: none;
            }
        }
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        button {
            background: none;
            border: none;
            cursor: pointer;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.4em;
        }
        button:hover {
            background-color: rgba(255,255,255,0.2);
        }
        #main-area {
            flex: 0 0 55dvh;
            position: relative;
        }
        #thumbnail-area {
            flex: 0 0 30dvh;
            padding: 10px;
            box-sizing: border-box;
            background-color: var(--bg-color);
        }
        #footer-area {
            flex: 0 0 5dvh;
            display: flex;
            align-items: center;
            padding: 0 15px;
            background-color: var(--secondary-color);
            color: black;
            font-size: 0.9em;
            box-sizing: border-box;
        }
        #progress {
            margin-right: 12px;
            font-size: 1.2em;
        }
        #status {
            flex: 1;
            text-align: center;
        }
        .swiper {
            height: 100%;
            width: 100%;
        }
        .gallery .swiper-slide {
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: flex-end;
            padding: 0px;
            color: white;
            text-shadow: 1px 1px 3px black;
            position: relative;
        }
        .poi-info {
            z-index: 2;
        }
        .poi-name {
            font-size: 2em;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .poi-dist {
            font-size: 1.2em;
        }
        .play-button {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 80px;
            height: 80px;
            font-size: 2.5em;
            background-color: rgba(0,0,0,0.5);
            z-index: 2;
            border-radius: 50%;
        }
        @media (max-height: 600px) {
            .play-button {
                width: 60px;
                height: 60px;
                font-size: 2em;
            }
        }
        .thumbs .swiper-slide {
            height: calc(100% - 30px);
            width: 160px;
            background-size: cover;
            background-position: center;
            border-radius: 12px;
            display: flex;
            align-items: flex-end;
            padding: 10px;
            color: white;
            text-shadow: 1px 1px 3px black;
            opacity: 0.6;
            transition: opacity 0.3s;
        }
        .thumbs .swiper-slide-thumb-active {
            opacity: 1;
            border: 3px solid var(--secondary-color);
        }
        .thumbs .poi-name {
            font-size: 1em;
        }
        #settings-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        #settings-form {
            background: var(--bg-color);
            color: var(--text-color);
            padding: 25px;
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            max-height: 90vh;
            overflow-y: auto;
        }
        #settings-form label {
            display: block;
            margin: 15px 0 8px;
            font-weight: bold;
        }
        .settings-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        .circle-btn {
            width: 60px;
            height: 60px;
            font-size: 1.8em;
            background-color: var(--main-color);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .circle-btn:hover {
            background-color: #00008b;
            opacity: 1;
        }
        .dark-mode .circle-btn:hover {
            background-color: #4169e1;
        }
        /* More Menu Styles */
        #more-menu {
            position: absolute;
            top: 100%;
            right: 15px;
            background: var(--bg-color);
            color: var(--text-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            min-width: 180px;
            z-index: 100;
            display: none;
            overflow: hidden;
        }
        #more-menu.show {
            display: block;
        }
        .menu-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1em;
        }
        .menu-item:hover {
            background-color: rgba(0,0,0,0.1);
        }
        .menu-item i {
            font-size: 1.1em;
            width: 20px;
            text-align: center;
        }
        .menu-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* POI Context Menu Styles */
        #poi-context-menu {
            position: absolute;
            background: var(--bg-color);
            color: var(--text-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            min-width: 180px;
            z-index: 100;
            display: none;
            overflow: hidden;
        }
        #poi-context-menu.show {
            display: block;
        }
        .poi-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1em;
        }
        .poi-menu-item:hover {
            background-color: rgba(0,0,0,0.1);
        }
        .poi-menu-item i {
            font-size: 1.1em;
            width: 20px;
            text-align: center;
        }
        /* Map Modal Styles */
        #map-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            display: none;
            flex-direction: column;
            z-index: 200;
        }
        #map-modal.show {
            display: flex;
        }
        #map-header {
            padding: 15px;
            background: var(--main-color);
            color: white;
            text-align: center;
            font-size: 1.2em;
            position: relative;
        }
        #current-coords {
            font-weight: bold;
        }
        #close-map {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 1.8em;
            cursor: pointer;
        }
        #map-container {
            flex: 1;
        }
        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="title-area">
        <div>
            <h1>AhGo!<span class="short-desc">Guide to Nearby Places</span></h1>
        </div>
        <div class="header-buttons">
            <button id="refresh" title="Refresh"><i class="fas fa-sync-alt"></i></button>
            <button id="settings-btn" title="Settings"><i class="fas fa-cog"></i></button>
            <button id="more-btn" title="More"><i class="fas fa-ellipsis-vertical"></i></button>
        </div>
        <!-- More Menu Dropdown -->
        <div id="more-menu">
            <div class="menu-item" id="menu-select-location">
                <i class="fas fa-map-marker-alt"></i> Select Map Location
            </div>
            <div class="menu-item" id="menu-print-locations">
                <i class="fas fa-print"></i> Print Locations List
            </div>
            <div class="menu-item" id="menu-show-map">
                <i class="fas fa-map"></i> Show Locations on Map
            </div>
            <div class="menu-item" id="menu-refresh-pois">
                <i class="fas fa-sync-alt"></i> Refresh POIs
            </div>
            <div class="menu-item" id="menu-clear-pois">
                <i class="fas fa-trash-alt"></i> Clear POIs
            </div>
        </div>
    </div>

    <div id="main-area">
        <div class="swiper gallery">
            <div class="swiper-wrapper"></div>
        </div>
    </div>

    <div id="thumbnail-area">
        <div class="swiper thumbs">
            <div class="swiper-wrapper"></div>
        </div>
    </div>

    <div id="footer-area">
        <div id="progress" style="display:none;"><i class="fas fa-spinner fa-spin"></i></div>
        <span id="status">Initializing...</span>
    </div>

    <div id="settings-modal">
        <form id="settings-form">
            <label>Units</label>
            <select id="units">
                <option value="metric">Metric (km/m)</option>
                <option value="imperial">Imperial (miles/ft)</option>
            </select>

            <label>Distance to get places</label>
            <select id="search-distance">
                <option value="1">1 mile</option>
                <option value="3">3 miles</option>
                <option value="5" selected>5 miles</option>
                <option value="10">10 miles</option>
                <option value="20">20 miles</option>
            </select>

            <label><input type="checkbox" id="dark-mode"> Dark Mode</label>

            <label><input type="checkbox" id="auto-check"> Automatically check every 30 seconds</label>

            <label>Text-to-Speech Voice</label>
            <select id="tts-voice"></select>

            <label>Categories of POIs</label>
            <div id="categories"></div>

            <label>Sources</label>
            <label><input type="checkbox" id="source-wiki" checked> Wikipedia</label>
            <label><input type="checkbox" id="source-osm" checked> OpenStreetMaps</label>

            <div class="settings-buttons">
                <button type="button" id="save-settings" class="circle-btn"><i class="fas fa-check"></i></button>
                <button type="button" id="cancel-settings" class="circle-btn"><i class="fas fa-times"></i></button>
            </div>
        </form>
    </div>

    <!-- Map Modal -->
    <div id="map-modal">
        <div id="map-header">
            Current location: <span id="current-coords">Unknown</span>
            <button id="close-map"><i class="fas fa-times"></i></button>
        </div>
        <div id="map-container">
            <div id="map"></div>
        </div>
    </div>

    <!-- POI Context Menu -->
    <div id="poi-context-menu">
        <div class="poi-menu-item" id="menu-show-details">
            <i class="fas fa-info-circle"></i> Show Details
        </div>
        <div class="poi-menu-item" id="menu-google-maps">
            <i class="fas fa-directions"></i> Open in Google Maps
        </div>
        <div class="poi-menu-item" id="menu-wikipedia">
            <i class="fab fa-wikipedia-w"></i> Open Wikipedia Page
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script>
        let gallerySwiper = null;
        let thumbsSwiper = null;
        let pois = [];
        let currentUtterance = null;
        let currentLat = null;
        let currentLon = null;
        let map = null;
        let mapMarkers = [];
        let selectedPoiIndex = -1;

        const defaultSettings = {
            units: 'metric',
            searchDistance: 5,
            darkMode: false,
            autoCheck: false,
            ttsVoice: '',
            categories: ['Attractions', 'Museums', 'Parks', 'Historic Sites'],
            sources: ['Wikipedia', 'OpenStreetMaps']
        };
        let settings = { ...defaultSettings };

        const categoryMap = {
            'Attractions': '["tourism"="attraction"]',
            'Museums': '["tourism"="museum"]',
            'Parks': '["leisure"="park"]',
            'Historic Sites': '["historic"]'
        };

        function loadSettings() {
            const saved = localStorage.getItem('ahgoSettings');
            if (saved) {
                settings = { ...defaultSettings, ...JSON.parse(saved) };
            }
            applySettings();
        }

        function applySettings() {
            document.body.classList.toggle('dark-mode', settings.darkMode);
            document.getElementById('units').value = settings.units;
            document.getElementById('search-distance').value = settings.searchDistance;
            document.getElementById('dark-mode').checked = settings.darkMode;
            document.getElementById('auto-check').checked = settings.autoCheck;
            document.getElementById('source-wiki').checked = settings.sources.includes('Wikipedia');
            document.getElementById('source-osm').checked = settings.sources.includes('OpenStreetMaps');
            populateCategories();

            if (settings.autoCheck) {
                if (window.autoInterval) clearInterval(window.autoInterval);
                window.autoInterval = setInterval(refreshPOIs, 30000);
            } else {
                if (window.autoInterval) clearInterval(window.autoInterval);
            }
        }

        function saveSettings() {
            settings.units = document.getElementById('units').value;
            settings.searchDistance = parseInt(document.getElementById('search-distance').value);
            settings.darkMode = document.getElementById('dark-mode').checked;
            settings.autoCheck = document.getElementById('auto-check').checked;
            settings.ttsVoice = document.getElementById('tts-voice').value;
            settings.sources = [];
            if (document.getElementById('source-wiki').checked) settings.sources.push('Wikipedia');
            if (document.getElementById('source-osm').checked) settings.sources.push('OpenStreetMaps');

            settings.categories = [];
            Object.keys(categoryMap).forEach(cat => {
                const id = `cat-${cat.replace(/\s+/g, '')}`;
                const cb = document.getElementById(id);
                if (cb && cb.checked) settings.categories.push(cat);
            });

            localStorage.setItem('ahgoSettings', JSON.stringify(settings));
            applySettings();
            document.getElementById('settings-modal').style.display = 'none';
            refreshPOIs();
        }

        function populateVoices() {
            const voices = speechSynthesis.getVoices();
            const select = document.getElementById('tts-voice');
            select.innerHTML = '<option value="">Default</option>';
            voices.forEach(voice => {
                const opt = document.createElement('option');
                opt.value = voice.name;
                opt.textContent = `${voice.name} (${voice.lang})${voice.default ? ' â€” Default' : ''}`;
                select.appendChild(opt);
            });
            if (settings.ttsVoice) select.value = settings.ttsVoice;
        }

        function populateCategories() {
            const container = document.getElementById('categories');
            container.innerHTML = '';
            Object.keys(categoryMap).forEach(cat => {
                const id = `cat-${cat.replace(/\s+/g, '')}`;
                const label = document.createElement('label');
                label.style.display = 'block';
                label.style.margin = '8px 0';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = id;
                input.checked = settings.categories.includes(cat);
                label.appendChild(input);
                label.appendChild(document.createTextNode(' ' + cat));
                container.appendChild(label);
            });
        }

        function showProgress(show) {
            document.getElementById('progress').style.display = show ? 'inline-block' : 'none';
        }

        function setStatus(text) {
            document.getElementById('status').textContent = text;
        }

        function haversineDistanceMiles(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)**2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const dKm = R * c;
            return dKm * 0.621371;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const distMiles = haversineDistanceMiles(lat1, lon1, lat2, lon2);
            if (settings.units === 'imperial') {
                return distMiles.toFixed(2) + ' miles';
            } else {
                return (distMiles * 1.60934).toFixed(2) + ' km';
            }
        }

        async function fetchPOIs(lat, lon) {
            currentLat = lat;
            currentLon = lon;
            showProgress(true);
            setStatus('Searching nearby places...');
            pois = [];

            const promises = [];
            if (settings.sources.includes('Wikipedia')) promises.push(fetchWikipedia(lat, lon));
            if (settings.sources.includes('OpenStreetMaps')) promises.push(fetchOSM(lat, lon));
	    if (settings.sources.includes('OpenStreetMaps')) promises.push(fetchUserPlaces(lat, lon));


            await Promise.all(promises);

            pois.sort((a, b) => a.distRaw - b.distRaw);
            updateGallery();
            showProgress(false);
            setStatus(pois.length ? `${pois.length} places found` : 'No places found nearby');
        }

        async function fetchWikipedia(lat, lon) {
            const baseUrl = 'https://en.wikipedia.org/w/api.php';
            const geoSearchUrl = `${baseUrl}?origin=*&action=query&format=json`
                + `&generator=geosearch&ggscoord=${lat}|${lon}&ggsradius=10000&ggslimit=50`
                + `&prop=coordinates|pageimages|extracts|info`
                + `&colimit=50&piprop=thumbnail&pithumbsize=400&pilimit=50`
                + `&exintro=1&explaintext=1&exsentences=3&exlimit=50`
                + `&inprop=url`;

            try {
                const res = await fetch(geoSearchUrl);
                const data = await res.json();

                if (!data.query?.pages) return;

                const pages = Object.values(data.query.pages);
                const fallbackTitles = [];

                for (const page of pages) {
                    if (!page.coordinates || !page.coordinates[0]) continue;

                    const coord = page.coordinates[0];
                    const distMiles = haversineDistanceMiles(lat, lon, coord.lat, coord.lon);

                    let desc = page.extract ? page.extract.trim() : '';

                    if (!desc || desc === '') {
                        fallbackTitles.push({
                            title: page.title,
                            pageid: page.pageid,
                            coord,
                            distMiles,
                            thumbnail: page.thumbnail?.source || '',
                            fullurl: page.fullurl || ''
                        });
                        desc = 'Loading description...';
                    } else {
                        desc = desc || 'No description available.';
                    }

                    pois.push({
                        name: page.title,
                        desc: desc,
                        dist: calculateDistance(lat, lon, coord.lat, coord.lon),
                        distRaw: distMiles,
                        source: 'Wikipedia',
                        image: page.thumbnail?.source || '',
                        lat: coord.lat,
                        lon: coord.lon,
                        fullurl: page.fullurl || ''
                    });
                }

                if (fallbackTitles.length > 0) {
                    const summaryPromises = fallbackTitles.map(async (item) => {
                        try {
                            const encodedTitle = encodeURIComponent(item.title);
                            const summaryUrl = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodedTitle}`;
                            const summaryRes = await fetch(summaryUrl);
                            const summaryData = await summaryRes.json();

                            if (summaryData.extract) {
                                return {
                                    title: item.title,
                                    extract: summaryData.extract.trim(),
                                    thumbnail: summaryData.thumbnail?.source || item.thumbnail
                                };
                            }
                        } catch (err) {
                            console.warn(`Failed to fetch summary for ${item.title}:`, err);
                        }
                        return null;
                    });

                    const summaries = await Promise.all(summaryPromises);

                    summaries.forEach((summary) => {
                        if (summary) {
                            const poiIndex = pois.findIndex(p => p.name === summary.title);
                            if (poiIndex !== -1) {
                                pois[poiIndex].desc = summary.extract || 'No description available.';
                                if (summary.thumbnail) {
                                    pois[poiIndex].image = summary.thumbnail;
                                }
                            }
                        }
                    });

                    pois.forEach(poi => {
                        if (poi.desc === 'Loading description...' || poi.desc === '') {
                            poi.desc = 'No description available.';
                        }
                    });
                }

            } catch (e) {
                console.error('Wikipedia fetch error:', e);
            }
        }

        async function fetchOSM(lat, lon) {
            let queries = settings.categories.map(cat => `node(around:${Math.round(settings.searchDistance * 1609.34)},${lat},${lon})${categoryMap[cat]};`).join('');
            if (!queries) return;
            const query = `[out:json][timeout:25];(${queries});out body;`;
            const url = 'https://overpass-api.de/api/interpreter';
            try {
                const res = await fetch(url, { method: 'POST', body: `data=${encodeURIComponent(query)}` });
                const data = await res.json();
                data.elements.forEach(el => {
                    if (el.tags?.name) {
                        let image = '';
                        if (el.tags.wikimedia_commons?.startsWith('File:')) {
                            const file = encodeURIComponent(el.tags.wikimedia_commons.slice(5));
                            image = `https://commons.wikimedia.org/wiki/Special:FilePath/${file}?width=600`;
                        } else if (el.tags.image?.startsWith('http')) {
                            image = el.tags.image;
                        }
                        const distMiles = haversineDistanceMiles(lat, lon, el.lat, el.lon);
                        pois.push({
                            name: el.tags.name,
                            desc: el.tags.description || (el.tags.wikipedia ? `See Wikipedia article on ${el.tags.wikipedia.split(':')[1] || el.tags.wikipedia}` : 'No description available.'),
                            dist: calculateDistance(lat, lon, el.lat, el.lon),
                            distRaw: distMiles,
                            source: 'OpenStreetMap',
                            image,
                            lat: el.lat,
                            lon: el.lon,
                            fullurl: el.tags.wikipedia ? `https://en.wikipedia.org/wiki/${encodeURIComponent(el.tags.wikipedia.split(':')[1] || el.tags.wikipedia)}` : ''
                        });
                    }
                });
            } catch (e) { console.error('OSM fetch error:', e); }
        }


async function fetchUserPlaces(lat, lon) {
    const maxDistanceMiles = 10; // Adjust this to match your desired search radius (similar to settings.searchDistance in OSM)
   

    try {
        // In a real environment (e.g., Node.js or browser with fetch), you would fetch the CSV file:
        const res = await fetch('places.csv');
        const csvText = await res.text();

        // For this example, we'll assume csvText is already loaded as a string
        // Replace this with actual loading logic as needed
        // const csvText = await fetch('places.csv').then(r => r.text());

        const lines = csvText.trim().split('\n');
        const headers = lines[0].split(',');

        // Find column indices
        const nameIdx = headers.indexOf('PlaceName');
        const descIdx = headers.indexOf('PlaceDescription');
        const imageIdx = headers.indexOf('image');
        const latIdx = headers.indexOf('lat');
        const lonIdx = headers.indexOf('lon');
        // Optional: tourIdx = headers.indexOf('tour'), tourOrderIdx = headers.indexOf('tour_order')

        for (let i = 1; i < lines.length; i++) {
            const values = [];
            let current = '';
            let inQuotes = false;
            for (let char of lines[i] + ',') {  // Add comma to flush last field
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }

            if (values.length < headers.length) continue; // Skip malformed lines

            try {
                const placeLat = parseFloat(values[latIdx]);
                const placeLon = parseFloat(values[lonIdx]);
                if (isNaN(placeLat) || isNaN(placeLon)) continue;

                const distMiles = haversineDistanceMiles(lat, lon, placeLat, placeLon);
                if (distMiles > maxDistanceMiles) continue;

                const image = values[imageIdx]?.trim() || '';
                const desc = values[descIdx]?.trim() || 'No description available.';

                pois.push({
                    name: values[nameIdx]?.trim() || 'Unnamed Place',
                    desc: desc,
                    dist: calculateDistance(lat, lon, placeLat, placeLon),  // Reuse your existing function
                    distRaw: distMiles,
                    source: 'UserCSV',
                    image,
                    lat: placeLat,
                    lon: placeLon,
                    fullurl: ''  // Add if you have a URL column
                    // Optional: tour: values[tourIdx], tour_order: parseInt(values[tourOrderIdx])
                });
            } catch (e) {
                console.warn('Skipping invalid row:', lines[i]);
            }
        }

        // Sort by distance (closest first)
        // pois.sort((a, b) => a.distRaw - b.distRaw);

    } catch (e) {
        console.error('User places CSV fetch/parse error:', e);
    }

    // You can now add these pois to your global pois array, e.g.:
    // pois.push(...loadedPois);
}


        function updateGallery() {
            const galleryWrapper = document.querySelector('.gallery .swiper-wrapper');
            const thumbsWrapper = document.querySelector('.thumbs .swiper-wrapper');
            galleryWrapper.innerHTML = '';
            thumbsWrapper.innerHTML = '';

            if (pois.length === 0) {
                galleryWrapper.innerHTML = '<div class="swiper-slide" style="display:flex;align-items:center;justify-content:center;color:white;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><h2>No places found</h2></div>';
                thumbsWrapper.innerHTML = '';
            } else {
                pois.forEach((poi, i) => {
                    const fallbackBg = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    const gSlide = document.createElement('div');
                    gSlide.className = 'swiper-slide';
                    gSlide.style.backgroundImage = poi.image ? `url(${poi.image})` : fallbackBg;
                    gSlide.innerHTML = `
                        <div class="poi-info">
                            <div class="poi-name" data-index="${i}">${poi.name}</div>
                            <div class="poi-dist">${poi.dist}</div>
                            <div class="poi-dist">${poi.source}</div>			
                        </div>
                        <button class="play-button" data-index="${i}"><i class="fas fa-play"></i></button>
                    `;
                    galleryWrapper.appendChild(gSlide);

                    const tSlide = document.createElement('div');
                    tSlide.className = 'swiper-slide';
                    tSlide.style.backgroundImage = poi.image ? `url(${poi.image})` : fallbackBg;
                    tSlide.innerHTML = `<div class="poi-name">${poi.name}</div>`;
                    thumbsWrapper.appendChild(tSlide);
                });
            }

            if (gallerySwiper) gallerySwiper.destroy(true, true);
            if (thumbsSwiper) thumbsSwiper.destroy(true, true);

            thumbsSwiper = new Swiper('.thumbs', {
                spaceBetween: 12,
                slidesPerView: 'auto',
                freeMode: true,
                watchSlidesProgress: true
            });

            gallerySwiper = new Swiper('.gallery', {
                spaceBetween: 5,
                width: window.innerWidth,
                height: window.innerHeight * 0.55,
                thumbs: {
                    swiper: thumbsSwiper
                }
            });

            gallerySwiper.on('slideChange', () => {
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                    document.querySelectorAll('.play-button i').forEach(ic => {
                        ic.classList.remove('fa-pause');
                        ic.classList.add('fa-play');
                    });
                }
            });

            document.querySelectorAll('.play-button').forEach(btn => {
                btn.addEventListener('click', toggleTTS);
            });

            // Add click listeners for POI names
            document.querySelectorAll('.poi-name').forEach(nameEl => {
                nameEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectedPoiIndex = parseInt(e.currentTarget.dataset.index);
                    showPoiContextMenu(e);
                });
            });
        }

        function showPoiContextMenu(e) {
            const menu = document.getElementById('poi-context-menu');
            menu.style.left = `${e.pageX}px`;
            menu.style.top = `${e.pageY}px`;
            menu.classList.add('show');

            // Hide menu on outside click
            const outsideClickListener = (ev) => {
                if (!menu.contains(ev.target)) {
                    menu.classList.remove('show');
                    document.removeEventListener('click', outsideClickListener);
                }
            };
            document.addEventListener('click', outsideClickListener);
        }

        function toggleTTS(e) {
            e.stopPropagation();
            const btn = e.currentTarget;
            const icon = btn.querySelector('i');
            const index = parseInt(btn.dataset.index);

            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                icon.classList.remove('fa-pause');
                icon.classList.add('fa-play');
            } else {
                const poi = pois[index];
                const text = `${poi.name}. ${poi.desc}`;
                currentUtterance = new SpeechSynthesisUtterance(text);

                const voices = speechSynthesis.getVoices();
                if (settings.ttsVoice) {
                    currentUtterance.voice = voices.find(v => v.name === settings.ttsVoice) || null;
                }

                currentUtterance.onend = () => {
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                };

                currentUtterance.onerror = () => {
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                };

                speechSynthesis.speak(currentUtterance);
                icon.classList.remove('fa-play');
                icon.classList.add('fa-pause');
            }
        }

        function refreshPOIs() {
            if (!navigator.geolocation) {
                setStatus('Geolocation not supported');
                showProgress(false);
                return;
            }
            setStatus('Requesting location permission...');
            navigator.geolocation.getCurrentPosition(
                pos => {
                    fetchPOIs(pos.coords.latitude, pos.coords.longitude);
                },
                err => {
                    let msg = 'Location access denied';
                    if (err.code === err.PERMISSION_DENIED) msg = 'Location permission denied';
                    else if (err.code === err.POSITION_UNAVAILABLE) msg = 'Location unavailable';
                    else if (err.code === err.TIMEOUT) msg = 'Location request timed out';
                    setStatus(msg);
                    showProgress(false);
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        function clearPOIs() {
            pois = [];
            updateGallery();
            setStatus('POIs cleared');
        }

        function printLocationsList() {
            if (pois.length === 0) {
                alert('No locations to display.');
                return;
            }

            let html = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Locations</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
        h1 { text-align: center; color: #333; }
        .location { margin-bottom: 40px; border-bottom: 1px solid #ddd; padding-bottom: 20px; }
        .name { font-size: 1.8em; font-weight: bold; color: #0066cc; margin-bottom: 10px; }
        .image { text-align: center; margin: 20px 0; }
        .image img { max-width: 100%; max-height: 400px; border-radius: 8px; }
        .desc { margin: 15px 0; }
        .coords { font-family: monospace; background: #f0f0f0; padding: 8px; border-radius: 4px; display: inline-block; }
        .source { color: #666; font-style: italic; }
        .no-image { color: #999; font-style: italic; }
    </style>
</head>
<body>
    <h1>Locations</h1>
`;

            pois.forEach(poi => {
                const lat = poi.lat !== undefined ? poi.lat.toFixed(6) : 'N/A';
                const lon = poi.lon !== undefined ? poi.lon.toFixed(6) : 'N/A';
                const coords = lat !== 'N/A' && lon !== 'N/A' ? `${lat}, ${lon}` : 'Not available';

                html += `
    <div class="location">
        <div class="name">${poi.name}</div>
        <div class="image">
            ${poi.image ? `<img src="${poi.image}" alt="${poi.name}">` : '<div class="no-image">No image available</div>'}
        </div>
        <div class="desc">${poi.desc || 'No description available.'}</div>
        <div><strong>Coordinates:</strong> <span class="coords">${coords}</span></div>
        <div class="source">Source: ${poi.source}</div>
    </div>
`;
            });

            html += `
</body>
</html>
`;

            const newTab = window.open('');
            newTab.document.write(html);
            newTab.document.close();
        }

        function showMap() {
            if (currentLat === null || currentLon === null) {
                alert('Current location not available yet. Please wait for POIs to load.');
                return;
            }
            if (pois.length === 0) {
                alert('No POIs loaded to display on map.');
                return;
            }

            document.getElementById('current-coords').textContent = `${currentLat.toFixed(6)}, ${currentLon.toFixed(6)}`;
            document.getElementById('map-modal').classList.add('show');

            if (!map) {
                map = L.map('map').setView([currentLat, currentLon], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);
            } else {
                map.setView([currentLat, currentLon], 13);
            }

            // Clear previous markers
            mapMarkers.forEach(m => map.removeLayer(m));
            mapMarkers = [];

            // Add current location marker (blue, unique)
            const userIcon = L.divIcon({
                className: 'user-location-marker',
                html: '<i class="fas fa-map-marker-alt" style="color:blue;font-size:24px;"></i>',
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            });
            const userMarker = L.marker([currentLat, currentLon], { icon: userIcon })
                .addTo(map)
                .bindPopup('You are here')
                .openPopup();
            mapMarkers.push(userMarker);

            // Add POI markers (default red)
            const bounds = L.latLngBounds([[currentLat, currentLon]]);
            pois.forEach(poi => {
                if (poi.lat && poi.lon) {
                    const marker = L.marker([poi.lat, poi.lon])
                        .addTo(map)
                        .bindPopup(`<b>${poi.name}</b><br>${poi.source}`);
                    mapMarkers.push(marker);
                    bounds.extend([poi.lat, poi.lon]);
                }
            });

            // Fit map to include all markers
            if (pois.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        function closeMap() {
            document.getElementById('map-modal').classList.remove('show');
        }

        // POI Context Menu Actions
        document.getElementById('menu-show-details').addEventListener('click', () => {
            alert('Show Details feature coming soon!');
            document.getElementById('poi-context-menu').classList.remove('show');
        });

        document.getElementById('menu-google-maps').addEventListener('click', () => {
            const poi = pois[selectedPoiIndex];
            if (poi.lat && poi.lon) {
                const url = `https://www.google.com/maps/search/?api=1&query=${poi.lat},${poi.lon}`;
                window.open(url, '_blank');
            } else {
                alert('Coordinates not available for this place.');
            }
            document.getElementById('poi-context-menu').classList.remove('show');
        });

        document.getElementById('menu-wikipedia').addEventListener('click', () => {
            const poi = pois[selectedPoiIndex];
            if (poi.fullurl) {
                window.open(poi.fullurl, '_blank');
            } else {
                alert('Wikipedia page not available for this place.');
            }
            document.getElementById('poi-context-menu').classList.remove('show');
        });

        // More Menu Toggle
        const moreBtn = document.getElementById('more-btn');
        const moreMenu = document.getElementById('more-menu');

        moreBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            moreMenu.classList.toggle('show');
        });

        document.addEventListener('click', (e) => {
            if (!moreBtn.contains(e.target) && !moreMenu.contains(e.target)) {
                moreMenu.classList.remove('show');
            }
        });

        // More Menu Items
        document.getElementById('menu-select-location').addEventListener('click', () => {
            alert('Select Map Location feature coming soon!');
            moreMenu.classList.remove('show');
        });

        document.getElementById('menu-print-locations').addEventListener('click', () => {
            printLocationsList();
            moreMenu.classList.remove('show');
        });

        document.getElementById('menu-show-map').addEventListener('click', () => {
            showMap();
            moreMenu.classList.remove('show');
        });

        document.getElementById('menu-refresh-pois').addEventListener('click', () => {
            refreshPOIs();
            moreMenu.classList.remove('show');
        });

        document.getElementById('menu-clear-pois').addEventListener('click', () => {
            clearPOIs();
            moreMenu.classList.remove('show');
        });

        document.getElementById('close-map').addEventListener('click', closeMap);

        document.getElementById('refresh').addEventListener('click', refreshPOIs);
        document.getElementById('settings-btn').addEventListener('click', () => {
            populateVoices();
            document.getElementById('settings-modal').style.display = 'flex';
        });
        document.getElementById('save-settings').addEventListener('click', saveSettings);
        document.getElementById('cancel-settings').addEventListener('click', () => {
            document.getElementById('settings-modal').style.display = 'none';
        });

        window.addEventListener('load', () => {
            loadSettings();
            populateVoices();
            speechSynthesis.onvoiceschanged = populateVoices;
            refreshPOIs();
        });
    </script>
</body>
</html>
